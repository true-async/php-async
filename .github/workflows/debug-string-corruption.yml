name: Debug String Corruption

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  debug-linux:
    name: "DEBUG_ZTS_string_corruption"
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout php-async repo
        uses: actions/checkout@v4
        with:
          path: async

      - name: Clone php-src (true-async branch)
        run: |
          git clone --depth=1 --branch=true-async https://github.com/true-async/php-src php-src

      - name: Copy php-async extension into php-src
        run: |
          mkdir -p php-src/ext/async
          cp -r async/* php-src/ext/async/

      - name: Install build dependencies
        working-directory: php-src
        run: |
          set -x
          sudo apt-get update -y
          sudo apt-get install -y \
            autoconf bison build-essential curl re2c \
            libxml2-dev libssl-dev pkg-config libargon2-dev \
            libcurl4-openssl-dev libedit-dev libsodium-dev \
            libsqlite3-dev libonig-dev libzip-dev libpng-dev \
            libjpeg-dev libwebp-dev libfreetype6-dev libgmp-dev \
            libldap2-dev libsasl2-dev libpq-dev libmysqlclient-dev \
            libbz2-dev libenchant-2-dev libffi-dev libgdbm-dev \
            liblmdb-dev libsnmp-dev libtidy-dev libxslt1-dev libicu-dev \
            cmake ninja-build

          # Build LibUV 1.48.0
          wget -q https://github.com/libuv/libuv/archive/v1.48.0.tar.gz
          tar -xzf v1.48.0.tar.gz
          cd libuv-1.48.0 && mkdir build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF
          ninja && sudo ninja install && sudo ldconfig
          cd ../..

          # Build libcurl
          wget -q https://github.com/curl/curl/releases/download/curl-8_5_0/curl-8.5.0.tar.gz
          tar -xzf curl-8.5.0.tar.gz
          cd curl-8.5.0
          ./configure --prefix=/usr/local --with-openssl --enable-shared --disable-static
          make -j$(nproc) && sudo make install && sudo ldconfig
          cd ..

      - name: Configure PHP
        working-directory: php-src
        run: |
          ./buildconf --force
          ./configure \
            --enable-option-checking=fatal \
            --prefix=/usr/local \
            --with-pdo-mysql=mysqlnd \
            --with-mysqli=mysqlnd \
            --with-pdo-sqlite \
            --without-pear \
            --enable-mbstring \
            --with-curl \
            --enable-sockets \
            --with-openssl \
            --with-zlib \
            --enable-bcmath \
            --with-bz2 \
            --with-gmp \
            --enable-intl \
            --with-sodium \
            --with-ffi \
            --enable-werror \
            --enable-debug \
            --enable-zts \
            --enable-async

      - name: Build and Install PHP
        working-directory: php-src
        run: |
          make -j$(nproc) >/dev/null
          sudo make install
          sudo mkdir -p /etc/php.d
          echo "opcache.enable_cli=1" | sudo tee /etc/php.d/opcache.ini

      - name: Run tests (reproduce corruption)
        working-directory: php-src/ext/async
        run: |
          /usr/local/bin/php -v
          /usr/local/bin/php ../../run-tests.php \
            -P -q -j4 \
            -g FAIL,BORK,LEAK,XLEAK \
            --no-progress \
            --offline \
            --show-diff \
            --show-slow 4000 \
            --set-timeout 120 \
            . 2>&1 || true
          echo "Exit code: $?"
